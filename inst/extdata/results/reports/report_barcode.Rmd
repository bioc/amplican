---
title: 'Report breakdown by Barcode'
author: amplican
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  html_document:
    toc: true
    theme: paper
    toc_float: true
    number_sections: true
---

```{r load data, message=F, warning=FALSE, include=FALSE}
results_folder = '/home/ai/Projects/amplican/inst/extdata/results'
library(amplican)
library(ggplot2)
alignments <- read.csv(paste0(results_folder, '/alignments.csv'))
config <- read.csv(paste0(results_folder, '/config_summary.csv'))
```

***

# Description  

***

**Read distribution plot** - plot shows number of reads assigned during read grouping  
**PRIMER DIMER filter** - plot shows percentage of assigned reads that have been recognized as PRIMER DIMERS  
**Cutting rates** - plot gives overview of percentage of reads (not filtered as PRIMER DIMER) that have cut  
**Frameshift** - plot shows what percentage of reads that have frameshift  
**Read heterogeneity plot** - shows what is the share of each of the unique reads in total count of all reads  


***

# Barcode Summary  

***

## Read distribution  

```{r plot total reads, echo=FALSE, fig.height=30, fig.width=14, message=F, warning=FALSE}
ggplot(data = config, aes(x = Barcode, y = log10(Reads + 1), order = Barcode, fill = ID)) +
  geom_bar(position='stack', stat='identity') +
  ylab('Number of reads on log10 scale')  +
  theme(legend.position = 'top',
        legend.direction = 'horizontal',
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14, face = 'bold'),
        legend.title = element_blank()) +
  coord_flip()
```

## PRIMER DIMER filter  

```{r plot PRIMER DIMER percentage, echo=FALSE, fig.height=30, fig.width=14, message=F, warning=FALSE}
barcodeTable <- aggregate(cbind(Reads, PRIMER_DIMER, Cut, Frameshift) ~ Barcode, data = config, sum)
barcodeTable$PD_percentage <- barcodeTable$PRIMER_DIMER * 100/barcodeTable$Reads
barcodeTable$PD_percentage[is.nan(barcodeTable$PD_percentage)] <- 0  

ggplot(data = barcodeTable, aes(x = Barcode, y = PD_percentage, order = Barcode)) +
  geom_bar(stat='identity') +
  ylab('Percentage of reads marked as PRIMER DIMERS')  +
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14, face = 'bold')) +
  ylim(0, 100) +
  coord_flip()
``` 

## Cut rates  

```{r plot cut percentage, echo=FALSE, fig.height=30, fig.width=14, message=F, warning=FALSE}
barcodeTable$Reads_noPD <- barcodeTable$Reads - barcodeTable$PRIMER_DIMER
barcodeTable$cut_percentage <- barcodeTable$Cut * 100/barcodeTable$Reads_noPD
barcodeTable$cut_percentage[is.nan(barcodeTable$cut_percentage)] <- 0  

ggplot(data = barcodeTable, aes(x = Barcode, y = cut_percentage, order = Barcode)) +
  geom_bar(stat = 'identity') +
  ylab('Percentage of reads (not marked as PRIMER DIMERS) that have cut site')  +
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14, face = 'bold')) +
  ylim(0,100) +
  coord_flip()
``` 

## Frameshift  

```{r plot frame shift percentage, echo=FALSE, fig.height=30, fig.width=14, message=F, warning=FALSE}
barcodeTable$frameshift_percentage <- barcodeTable$Frameshift * 100/barcodeTable$Reads_noPD
barcodeTable$frameshift_percentage[is.nan(barcodeTable$frameshift_percentage)] <- 0  

ggplot(data = barcodeTable, aes(x = Barcode, y = frameshift_percentage, order = Barcode)) +
  geom_bar(position = 'stack', stat = 'identity') +
  ylab('Percentage of reads (not marked as PRIMER DIMERS) that have frameshift')  +
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14,face = 'bold')) +
  ylim(0, 100) +
  coord_flip()
``` 

## Heterogeneity of reads  

```{r plot read heterogeneity, echo=FALSE, fig.height=30, fig.width=14, message=F, warning=FALSE}
alignments$ID_read_id <- paste0(alignments$seqnames, '_', alignments$read_id)
uniqueReadsByID <- alignments[!duplicated(alignments$ID_read_id), c('seqnames', 'read_id', 'count')]
uniqueReadsByID <- uniqueReadsByID[order(uniqueReadsByID$seqnames, uniqueReadsByID$count, decreasing = T),]

howManyTimes <- aggregate(read_id ~ seqnames, data = uniqueReadsByID, length)
howManyTimes <- howManyTimes[match(howManyTimes$seqnames, unique(uniqueReadsByID$seqnames)),] 

uniqueReadsByID$barcode <- rep(config$Barcode[match(howManyTimes$seqnames, unique(config$ID))], 
                               times = howManyTimes$read_id)

uniqueReadsByID <- uniqueReadsByID[order(uniqueReadsByID$barcode, uniqueReadsByID$count, decreasing = T),]

cumsum_list <- tapply(uniqueReadsByID$count, as.vector(uniqueReadsByID$barcode), FUN = cumsum)
cumsum_list <- cumsum_list[match(names(cumsum_list), unique(uniqueReadsByID$barcode))]
uniqueReadsByID$cumsum <- do.call(c, cumsum_list)

seq2 <- Vectorize(seq.default, vectorize.args = c('from', 'to'))
howManyTimes <- table(as.vector(uniqueReadsByID$barcode))
howManyTimes <- howManyTimes[match(names(howManyTimes), unique(uniqueReadsByID$barcode))]
uniqueReadsByID$read_number <- unlist(seq2(from = rep(1, dim(howManyTimes)[1]), to = howManyTimes, by = 1))

ids_with_reads <- tapply(uniqueReadsByID$cumsum, as.vector(uniqueReadsByID$barcode), FUN = max)
ids_with_reads <- ids_with_reads[match(names(ids_with_reads), unique(uniqueReadsByID$barcode))]

toDivide <- rep(ids_with_reads, times = howManyTimes)
uniqueReadsByID$read_share_percentage <- uniqueReadsByID$cumsum * 100 / toDivide
uniqueReadsByID$read_share_percentage_normal <- uniqueReadsByID$count * 100 / toDivide  

ggplot(data = uniqueReadsByID, aes(x = barcode, y = read_share_percentage_normal, fill = read_share_percentage_normal)) +
  geom_bar(position = 'stack', stat = 'identity') +
  theme(legend.position = 'top',
        axis.text = element_text(size=12),
        axis.title=element_text(size=14,face = 'bold'),
        legend.direction = 'horizontal', 
        legend.title = element_blank()) +
  ylab('Unique reads percentage of contribution') +
  xlab('Barcode') +
  coord_flip()
``` 

