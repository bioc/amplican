---
title: 'Report breakdown by Barcode'
author: amplican
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  html_document:
    toc: true
    theme: paper
    toc_float: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{example barcode report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r load data, message=F, warning=FALSE, include=FALSE}
results_folder = system.file('extdata', 'results', package = 'amplican')
library(amplican)
library(ggplot2)
alignments <- read.csv(file.path(results_folder, 'alignments_events.csv'), stringsAsFactors = FALSE)
config <- read.csv(file.path(results_folder, 'config_summary.csv'), stringsAsFactors = FALSE)
```

***

# Description  

***

**Read distribution plot** - plot shows number of reads assigned during read grouping  
**PRIMER DIMER filter** - plot shows percentage of assigned reads that have been recognized as PRIMER DIMERS  
**Cutting rates** - plot gives overview of percentage of reads (not filtered as PRIMER DIMER) that have cut  
**Frameshift** - plot shows what percentage of reads that have frameshift  
**Read heterogeneity plot** - shows what is the share of each of the unique reads in total count of all reads. The more blue each row, the less heterogeneity in the reads, more green means reads don't repeat often and are unique  
**Top unassigned reads** - take a look at the alignment of most abundant 
forward and reverse complemented reverse reads for each barcode, 
if you find that there is many unassigned reads you can ivestigate here.  

***

# Barcode Summary  

***

## Read distribution  

```{r plot total reads, echo=FALSE, fig.height=3, fig.width=14, message=F, warning=FALSE}
ggplot(data = config, aes(x = Barcode, y = log10(Reads + 1), order = Barcode, fill = ID)) +
  geom_bar(position='stack', stat='identity') +
  ylab('Number of reads + 1, log10 scaled')  +
  theme(legend.position = 'top',
        legend.direction = 'horizontal',
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14, face = 'bold'),
        legend.title = element_blank()) +
  coord_flip()
```

## PRIMER DIMER filter  

```{r plot PRIMER DIMER percentage, echo=FALSE, fig.height=3, fig.width=14, message=F, warning=FALSE}
barcodeTable <- aggregate(cbind(Reads, PRIMER_DIMER, Cut, Frameshift) ~ Barcode, data = config, sum)
barcodeTable$PD_percentage <- barcodeTable$PRIMER_DIMER * 100/barcodeTable$Reads
barcodeTable$PD_percentage[is.nan(barcodeTable$PD_percentage)] <- 0  

ggplot(data = barcodeTable, aes(x = Barcode, y = PD_percentage, order = Barcode)) +
  geom_bar(stat='identity') +
  ylab('Percentage of reads marked as PRIMER DIMERS')  +
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14, face = 'bold')) +
  ylim(0, 100) +
  coord_flip() +
  geom_text(aes(x = Barcode, y = PD_percentage, label = PRIMER_DIMER), hjust = -1)
``` 

## Cut rates  

```{r plot cut percentage, echo=FALSE, fig.height=3, fig.width=14, message=F, warning=FALSE}
barcodeTable$Reads_noPD <- barcodeTable$Reads - barcodeTable$PRIMER_DIMER
barcodeTable$cut_percentage <- barcodeTable$Cut * 100/barcodeTable$Reads_noPD
barcodeTable$cut_percentage[is.nan(barcodeTable$cut_percentage)] <- 0  

ggplot(data = barcodeTable, aes(x = Barcode, y = cut_percentage, order = Barcode)) +
  geom_bar(stat = 'identity') +
  ylab('Percentage of reads (not marked as PRIMER DIMERS) that have cut site')  +
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14, face = 'bold')) +
  ylim(0,100) +
  coord_flip() +
  geom_text(aes(x = Barcode, y = cut_percentage, label = Cut), hjust = -1)
``` 

## Frameshift  

```{r plot frame shift percentage, echo=FALSE, fig.height=3, fig.width=14, message=F, warning=FALSE}
barcodeTable$frameshift_percentage <- barcodeTable$Frameshift * 100/barcodeTable$Reads_noPD
barcodeTable$frameshift_percentage[is.nan(barcodeTable$frameshift_percentage)] <- 0  

ggplot(data = barcodeTable, aes(x = Barcode, y = frameshift_percentage, order = Barcode)) +
  geom_bar(position = 'stack', stat = 'identity') +
  ylab('Percentage of reads (not marked as PRIMER DIMERS) that have frameshift')  +
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14,face = 'bold')) +
  ylim(0, 100) +
  coord_flip() +
  geom_text(aes(x = Barcode, y = frameshift_percentage, label = Frameshift), hjust = -1)
``` 

## Heterogeneity of reads  

```{r plot read heterogeneity, echo=FALSE, fig.height=3, fig.width=14, message=F, warning=FALSE}
alignments$ID_read_id <- paste0(alignments$seqnames, '_', alignments$read_id)
uniqueReadsByID <- alignments[!duplicated(alignments$ID_read_id), c('seqnames', 'read_id', 'count')]
uniqueReadsByID <- uniqueReadsByID[order(uniqueReadsByID$seqnames, uniqueReadsByID$count, decreasing = T),]

howManyTimes <- aggregate(read_id ~ seqnames, data = uniqueReadsByID, length)
howManyTimes <- howManyTimes[match(howManyTimes$seqnames, unique(uniqueReadsByID$seqnames)),] 

uniqueReadsByID$barcode <- rep(config$Barcode[match(howManyTimes$seqnames, unique(config$ID))], 
                               times = howManyTimes$read_id)

uniqueReadsByID <- uniqueReadsByID[order(uniqueReadsByID$barcode, uniqueReadsByID$count, decreasing = T),]

cumsum_list <- tapply(uniqueReadsByID$count, as.vector(uniqueReadsByID$barcode), FUN = cumsum)
cumsum_list <- cumsum_list[match(names(cumsum_list), unique(uniqueReadsByID$barcode))]
uniqueReadsByID$cumsum <- do.call(c, cumsum_list)

seq2 <- Vectorize(seq.default, vectorize.args = c('from', 'to'))
howManyTimes <- table(as.vector(uniqueReadsByID$barcode))
howManyTimes <- howManyTimes[match(names(howManyTimes), unique(uniqueReadsByID$barcode))]
dimHMT <- if (is.null(dim(howManyTimes)[1])) { length(howManyTimes) } else { dim(howManyTimes)[1] }
uniqueReadsByID$read_number <- as.vector(unlist(seq2(from = rep(1, dimHMT), to = howManyTimes, by = 1)))

ids_with_reads <- tapply(uniqueReadsByID$cumsum, as.vector(uniqueReadsByID$barcode), FUN = max)
ids_with_reads <- ids_with_reads[match(names(ids_with_reads), unique(uniqueReadsByID$barcode))]

toDivide <- rep(ids_with_reads, times = howManyTimes)
uniqueReadsByID$read_share_percentage <- uniqueReadsByID$cumsum * 100 / toDivide
uniqueReadsByID$read_share_percentage_normal <- uniqueReadsByID$count * 100 / toDivide  

# divide into bins for colour
uniqueReadsByID$bins <- cut(uniqueReadsByID$read_share_percentage_normal,
c(0, 5, seq(10, 100, 10)))
# reduce number of reads in 0-5 group - faster plots without artifacts
uniqueReadsByID <- aggregate(read_share_percentage_normal ~ barcode + bins,
data = uniqueReadsByID, sum)
colorPalette <- colorRampPalette(c('#009E73', '#0072B2'))(length(levels(uniqueReadsByID$bins)))
names(colorPalette) <- levels(uniqueReadsByID$bins)
ggplot(data = uniqueReadsByID, aes(x = as.factor(barcode), y = read_share_percentage_normal, fill = bins)) +
  geom_bar(position = 'stack', stat = 'identity') +
  theme(legend.position = 'top',
        axis.text = element_text(size=12),
        axis.title=element_text(size=14,face = 'bold'),
        legend.direction = 'horizontal', 
        legend.title = element_blank()) +
  ylab('Unique reads percentage of contribution') +
  scale_fill_manual(values = colorPalette) +
  xlab('Barcode') +
  coord_flip()
``` 

***

# Top unassigned reads  

***

## barcode_1  

```{r plot unassigned reads barcode_1, echo=FALSE, message=F, warning=FALSE, comment = ''}
unassigned_reads <- read.csv(file.path(results_folder, 'alignments', 'unassigned_sequences', 'barcode_1_unassigned_reads.csv'), stringsAsFactors = FALSE)
unassigned_reads <- unassigned_reads[order(unassigned_reads$BarcodeFrequency, decreasing = TRUE), ]
if (dim(unassigned_reads)[1] == 0) {
  "No unassigned reads in this barcode. That's great!"
} else {
  topN <- if (dim(unassigned_reads)[1] < 5) dim(unassigned_reads)[1] else 5
  knitr::kable(data.frame(Forward = paste0('P', 1:topN),
                          Reverse = paste0('S', 1:topN),
                          Counts = unassigned_reads[1:topN, 'Total'],
                          Frequency = unassigned_reads[1:topN, 'BarcodeFrequency']))

  knitr::asis_output(cat(amplican_print_reads(unassigned_reads[1:topN, 'Forward'],
                                              unassigned_reads[1:topN, 'Reverse']), sep = '
'))
}
```

## barcode_2  

```{r plot unassigned reads barcode_2, echo=FALSE, message=F, warning=FALSE, comment = ''}
unassigned_reads <- read.csv(file.path(results_folder, 'alignments', 'unassigned_sequences', 'barcode_2_unassigned_reads.csv'), stringsAsFactors = FALSE)
unassigned_reads <- unassigned_reads[order(unassigned_reads$BarcodeFrequency, decreasing = TRUE), ]
if (dim(unassigned_reads)[1] == 0) {
  "No unassigned reads in this barcode. That's great!"
} else {
  topN <- if (dim(unassigned_reads)[1] < 5) dim(unassigned_reads)[1] else 5
  knitr::kable(data.frame(Forward = paste0('P', 1:topN),
                          Reverse = paste0('S', 1:topN),
                          Counts = unassigned_reads[1:topN, 'Total'],
                          Frequency = unassigned_reads[1:topN, 'BarcodeFrequency']))

  knitr::asis_output(cat(amplican_print_reads(unassigned_reads[1:topN, 'Forward'],
                                              unassigned_reads[1:topN, 'Reverse']), sep = '
'))
}
```

